<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laporan Keuangan K-PT DKE</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ====== CETAK (GLOBAL) ====== -->
  <style>
    @page { margin: 12mm; }
    @media print {
      .sidebar, .topbar, .no-print, .panel-header .btn, td .btn, .actions, button, a.btn { display: none !important; }
      .panel:has(form) { display: none !important; }
      #view-receipt   .panel:first-of-type,
      #view-quotation .panel:first-of-type,
      #view-invoice   .panel:first-of-type { display: none !important; }
      table.has-actions th:last-child,
      table.has-actions td:last-child { display: none !important; }
      .main  { width:100% !important; margin:0 !important; padding:0 6mm !important; }
      .view  { padding:0 !important; margin:0 !important; }
      .panel { box-shadow:none !important; margin:0 0 8mm !important; }
      .print-area { display:block !important; page-break-inside:avoid; margin-top:4mm; }
    }
  </style>

  <!-- ====== RESPONSIVE ADD-ON ====== -->
  <style>
    :root{
      --sidebar-w: 280px;
      --shadow: 0 6px 16px rgba(0,0,0,.08);
      --card:#fff;
      --muted:#64748b;
    }
    .topbar{ position: sticky; top:0; z-index: 900; background: var(--card); }
    .topbar-inner{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .left-pack{ display:flex; align-items:center; gap:10px; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; height:44px; padding:0 14px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.icon{ width:44px; padding:0; }

    @media (max-width: 768px){
      .table-wrap{ overflow: visible; }
      table.table{ width:100%; border-collapse: collapse; }
      table.table thead{ display:none; }
      table.table, table.table tbody, table.table tr, table.table td{ display:block; width:100%; }
      table.table tr{ background:var(--card); border:1px solid #e5e7eb; border-radius:12px; box-shadow: var(--shadow); padding:10px; margin-bottom:10px; }
      table.table td{ display:grid; grid-template-columns: 42% 1fr; gap:8px; border:0; padding:6px 0; }
      table.table td::before{ content: attr(data-label); color: var(--muted); font-weight:600; }
      table.table td.num{ text-align:right; }
    }

    @media (max-width: 768px){
      .app{ display:grid; grid-template-columns: 1fr; min-height:100dvh; }
      .sidebar{
        position: fixed; inset: 0 auto 0 0; width: min(88vw, var(--sidebar-w));
        transform: translateX(-100%); transition: transform .25s ease;
        background: var(--card); box-shadow: var(--shadow); z-index: 1000;
        padding:16px; overflow:auto;
      }
      .sidebar.open{ transform: translateX(0); }
      .main{ padding:12px; }
    }

    @media (min-width: 769px){
      .topbar .btn.menu{ display:none; }
    }
  </style>

  <!-- ========== Supabase Auth Guard + Client Global ========== -->
  <script>
    const SUPABASE_URL = 'https://jllomycpshgbhppipyaj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbG9teWNwc2hnYmhwcGlweWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzg2OTcsImV4cCI6MjA3NTg1NDY5N30.DQYcB25G6blGpQnxyLlaqsX8OTXWMc7q51EtJN35vY4';
    const EMAIL_REDIRECT = 'https://tbmanjaddawajadda.pro/verify.html';

    // Buat client & ekspor ke global agar script.js bisa pakai
    window.__supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Guard: wajib login & email verified
    (async () => {
      try {
        const { data: { user } } = await __supa.auth.getUser();
        if (!user) return window.location.replace('login.html');
        if (!user.email_confirmed_at) return window.location.replace('verify.html');
        // jika lolos, biarkan halaman lanjut
      } catch (e) {
        window.location.replace('login.html');
      }
    })();
  </script>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="appSidebar">
      <div class="brand">KeuDe</div>
      <nav class="menu">
        <button class="nav-link active" data-view="dashboard">Dashboard</button>
        <div class="menu-sep">Laporan</div>
        <button class="nav-link" data-view="balance-sheet">Laporan Neraca</button>
        <button class="nav-link" data-view="cash-flow">Laporan Arus Kas</button>
        <button class="nav-link" data-view="income-statement">Laporan Laba Rugi</button>
        <button class="nav-link" data-view="report-income">Laporan Pemasukan</button>
        <button class="nav-link" data-view="report-expense">Laporan Pengeluaran</button>
        <button class="nav-link" data-view="report-tax">Laporan Pembayaran Pajak</button>
        <div class="menu-sep">Dokumen</div>
        <button class="nav-link" data-view="receipt">Cetak Kwitansi</button>
        <button class="nav-link" data-view="quotation">Penawaran Harga</button>
        <button class="nav-link" data-view="invoice">Invoice</button>
        <div class="menu-sep">Data</div>
        <button class="nav-link" data-view="settings">Export / Import</button>
      </nav>
      <footer class="sidebar-footer">
        <small>© <span id="year"></span> KeuDe</small>
        <div class="auth" style="margin-top:10px">
          <div id="authStatus">Belum login</div>
          <a href="login.html" class="btn" id="btnGoLogin" style="margin-top:6px">Login/Signup</a>
          <button id="btnSignOut" class="btn" style="margin-top:6px; display:none">Logout</button>
        </div>
      </footer>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="left-pack">
            <button id="menuBtn" class="btn menu icon" aria-expanded="false" aria-controls="appSidebar" aria-label="Buka menu">☰</button>
            <h1 id="viewTitle" style="margin:0">Dashboard</h1>
          </div>
          <div class="topbar-actions">
            <button id="btnAddIncome" class="btn primary">+ Pemasukan</button>
            <button id="btnAddExpense" class="btn danger">+ Pengeluaran</button>
            <button id="btnAddTax" class="btn warning">+ Pajak</button>
          </div>
        </div>
      </header>

      <!-- DASHBOARD -->
      <section class="view" id="view-dashboard">
        <div class="cards">
          <div class="card"><div class="card-title">Saldo Kas</div><div class="stat" id="statCash">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pemasukan (bulan ini)</div><div class="stat" id="statIncome">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pengeluaran (bulan ini)</div><div class="stat" id="statExpense">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pajak (bulan ini)</div><div class="stat" id="statTax">Rp 0</div></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3>Transaksi Terbaru</h3>
            <div>
              <input type="month" id="dashMonth" />
              <button class="btn" id="btnDashFilter">Terapkan</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table has-actions">
              <thead>
                <tr>
                  <th>Tanggal</th><th>Jenis</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th><th>Aksi</th>
                </tr>
              </thead>
              <tbody id="tblRecent"></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3>Dokumen Cepat</h3>
            <div class="actions">
              <button class="btn" data-view-jump="receipt">Buat Kwitansi</button>
              <button class="btn" data-view-jump="quotation">Buat Penawaran</button>
              <button class="btn" data-view-jump="invoice">Buat Invoice</button>
            </div>
          </div>
          <p>Dokumen-dokumen ini akan terikat ke transaksi (jika relevan) dan bisa dicetak langsung.</p>
        </div>
      </section>

      <!-- NERACA -->
      <section class="view hidden" id="view-balance-sheet">
        <div class="panel">
          <div class="panel-header">
            <h3>Neraca</h3>
            <div>
              <input type="date" id="bsDate" />
              <button class="btn" id="btnBsRun">Hitung</button>
              <button class="btn" id="btnBsPrint">Cetak</button>
            </div>
          </div>
          <div id="bsResult"></div>
        </div>
      </section>

      <!-- ARUS KAS -->
      <section class="view hidden" id="view-cash-flow">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Arus Kas</h3>
            <div>
              <input type="month" id="cfMonth" />
              <button class="btn" id="btnCfRun">Hitung</button>
              <button class="btn" id="btnCfPrint">Cetak</button>
            </div>
          </div>
          <div id="cfResult"></div>
        </div>
      </section>

      <!-- LABA RUGI -->
      <section class="view hidden" id="view-income-statement">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Laba Rugi</h3>
            <div>
              <input type="month" id="isMonth" />
              <button class="btn" id="btnIsRun">Hitung</button>
              <button class="btn" id="btnIsPrint">Cetak</button>
            </div>
          </div>
          <div id="isResult"></div>
        </div>
      </section>

      <!-- LAPORAN PEMASUKAN -->
      <section class="view hidden" id="view-report-income">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pemasukan</h3>
            <div>
              <input type="month" id="riMonth" />
              <button class="btn" id="btnRiRun">Terapkan</button>
              <button class="btn" id="btnRiExport">Export CSV</button>
              <button class="btn" id="btnRiPrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="riBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="riTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- LAPORAN PENGELUARAN -->
      <section class="view hidden" id="view-report-expense">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pengeluaran</h3>
            <div>
              <input type="month" id="reMonth" />
              <button class="btn" id="btnReRun">Terapkan</button>
              <button class="btn" id="btnReExport">Export CSV</button>
              <button class="btn" id="btnRePrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="reBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="reTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- LAPORAN PAJAK -->
      <section class="view hidden" id="view-report-tax">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pembayaran Pajak</h3>
            <div>
              <input type="month" id="rtMonth" />
              <button class="btn" id="btnRtRun">Terapkan</button>
              <button class="btn" id="btnRtExport">Export CSV</button>
              <button class="btn" id="btnRtPrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="rtBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="rtTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- KWITANSI -->
      <section class="view hidden" id="view-receipt">
        <div class="panel">
          <div class="panel-header">
            <h3>Form Kwitansi</h3>
            <div>
              <button class="btn" id="btnReceiptNew">Baru</button>
              <button class="btn" id="btnReceiptPrint">Cetak</button>
            </div>
          </div>
          <form class="grid-2" id="formReceipt">
            <label>Nomor Kwitansi <input type="text" name="number" required /></label>
            <label>Tanggal <input type="date" name="date" required /></label>
            <label>Diterima dari <input type="text" name="from" required /></label>
            <label>Untuk Pembayaran <input type="text" name="for" required /></label>
            <label>Jumlah (Rp) <input type="number" step="0.01" name="amount" required /></label>
            <label>Metode <input type="text" name="method" placeholder="Transfer/Tunai" /></label>
            <label>Keterangan <input type="text" name="notes" /></label>
            <div class="actions">
              <button class="btn primary" id="btnReceiptSave" type="submit">Simpan</button>
            </div>
          </form>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>PT DKE Kwitansi</h3></div>
          <div class="table-wrap">
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Dari</th><th>Jumlah</th><th>Aksi</th></tr></thead>
              <tbody id="receiptList"></tbody>
            </table>
          </div>
        </div>

        <div id="printAreaReceipt" class="print-area"></div>
      </section>

      <!-- QUOTATION -->
      <section class="view hidden" id="view-quotation">
        <div class="panel">
          <div class="panel-header">
            <h3>Penawaran Harga</h3>
            <div>
              <button class="btn" id="btnQuoteNew">Baru</button>
              <button class="btn" id="btnQuotePrint">Cetak</button>
            </div>
          </div>

          <form id="formQuote" class="grid-2">
            <label>No. Penawaran <input type="text" name="number" required></label>
            <label>Tanggal <input type="date" name="date" required></label>
            <label>Nama Klien <input type="text" name="client" required></label>
            <label>Email/Telepon <input type="text" name="contact"></label>
            <div class="full">
              <div class="items">
                <div class="items-header">
                  <span>Item</span><span>Qty</span><span>Harga</span><span>Subtotal</span><span></span>
                </div>
                <div id="quoteItems"></div>
                <button class="btn" id="btnQuoteAddItem" type="button">+ Item</button>
              </div>
            </div>
            <label>Diskon (%) <input type="number" step="0.01" name="discountPct" value="0"></label>
            <label>Pajak (%) <input type="number" step="0.01" name="taxPct" value="0"></label>
            <label class="full">Catatan <textarea name="notes" rows="3"></textarea></label>
            <div class="actions">
              <button class="btn primary" id="btnQuoteSave" type="submit">Simpan</button>
            </div>
          </form>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>Daftar Penawaran</h3></div>
          <div class="table-wrap">
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Klien</th><th class="num">Total</th><th>Aksi</th></tr></thead>
              <tbody id="quoteList"></tbody>
            </table>
          </div>
        </div>

        <div id="printAreaQuote" class="print-area"></div>
      </section>

      <!-- INVOICE -->
      <section class="view hidden" id="view-invoice">
        <div class="panel">
          <div class="panel-header">
            <h3>Invoice</h3>
            <div>
              <button class="btn" id="btnInvNew">Baru</button>
              <button class="btn" id="btnInvPrint">Cetak</button>
            </div>
          </div>

        <form id="formInv" class="grid-2">
          <label>No. Invoice <input type="text" name="number" required></label>
          <label>Tanggal <input type="date" name="date" required></label>
          <label>Jatuh Tempo <input type="date" name="dueDate" required></label>
          <label>Nama Klien <input type="text" name="client" required></label>
          <div class="full">
            <div class="items">
              <div class="items-header">
                <span>Item</span><span>Qty</span><span>Harga</span><span>Subtotal</span><span></span>
              </div>
              <div id="invItems"></div>
              <button class="btn" id="btnInvAddItem" type="button">+ Item</button>
            </div>
          </div>
          <label>Diskon (%) <input type="number" step="0.01" name="discountPct" value="0"></label>
          <label>Pajak (%) <input type="number" step="0.01" name="taxPct" value="0"></label>
          <label>Status
            <select name="status">
              <option>Draft</option>
              <option>Sent</option>
              <option>Paid</option>
            </select>
          </label>
          <label class="full">Catatan <textarea name="notes" rows="3"></textarea></label>
          <div class="actions">
            <button class="btn primary" id="btnInvSave" type="submit">Simpan</button>
          </div>
        </form>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>Daftar Invoice</h3></div>
          <div class="table-wrap">
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Klien</th><th>Status</th><th class="num">Total</th><th>Aksi</th></tr></thead>
              <tbody id="invList"></tbody>
            </table>
          </div>
        </div>

        <div id="printAreaInv" class="print-area"></div>
      </section>

      <!-- SETTINGS -->
      <section class="view hidden" id="view-settings">
        <div class="panel">
          <div class="panel-header"><h3>Export / Import Data</h3></div>
          <div class="grid-2">
            <div>
              <p>Export seluruh data (transaksi, kwitansi, penawaran, invoice) ke file JSON.</p>
              <button class="btn" id="btnExport">Export JSON</button>
            </div>
            <div>
              <p>Import data dari file JSON (akan menimpa data yang ada).</p>
              <input type="file" id="fileImport" accept="application/json" />
              <button class="btn" id="btnImport">Import</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- DIALOG TRANSAKSI -->
  <dialog id="txDialog">
    <form method="dialog" id="formTx" class="tx-form">
      <h3 id="txTitle">Tambah Transaksi</h3>
      <label>Tanggal <input type="date" name="date" required /></label>
      <label>Jenis
        <select name="type">
          <option value="income">Pemasukan</option>
          <option value="expense">Pengeluaran</option>
          <option value="tax">Pajak</option>
        </select>
      </label>
      <label>Kategori <input type="text" name="category" placeholder="Penjualan, Operasional, PPh, dll" /></label>
      <label>Deskripsi <input type="text" name="description" /></label>
      <label>Nominal (Rp) <input type="number" step="0.01" name="amount" required /></label>
      <menu>
        <button value="cancel" class="btn">Batal</button>
        <button value="ok" class="btn primary" id="btnTxSave">Simpan</button>
      </menu>
    </form>
  </dialog>

  <template id="tmplItemRow">
    <div class="item-row">
      <input class="it-desc" placeholder="Deskripsi" />
      <input class="it-qty" type="number" step="0.01" value="1" />
      <input class="it-price" type="number" step="0.01" value="0" />
      <div class="it-subtotal">Rp 0</div>
      <button class="btn tiny danger it-del" type="button">×</button>
    </div>
  </template>

  <!-- App utama (akan memanfaatkan window.__supa) -->
  <script src="script.js"></script>

  <!-- ====== UI helper ====== -->
  <script>
    (function(){
      const sidebar = document.getElementById('appSidebar');
      const menuBtn  = document.getElementById('menuBtn');
      const authStatus = document.getElementById('authStatus');
      const btnLogin = document.getElementById('btnGoLogin');
      const btnSignOut = document.getElementById('btnSignOut');

      // Toggle drawer
      menuBtn?.addEventListener('click', ()=>{
        const open = sidebar.classList.toggle('open');
        menuBtn.setAttribute('aria-expanded', String(open));
        document.documentElement.style.overflow = open ? 'hidden' : '';
      });

      // Tutup bila klik di luar sidebar (mobile)
      document.addEventListener('click', (e)=>{
        if(window.matchMedia('(max-width:768px)').matches){
          if(sidebar.classList.contains('open')){
            const inside = sidebar.contains(e.target) || (menuBtn && menuBtn.contains(e.target));
            if(!inside){ sidebar.classList.remove('open'); document.documentElement.style.overflow=''; }
          }
        }
      });

      // Tahun footer
      const y = document.getElementById('year'); if(y) y.textContent = new Date().getFullYear();

      // Tampilkan status login + tombol logout
      (async () => {
        const { data: { user } } = await __supa.auth.getUser();
        if (user) {
          authStatus.textContent = user.email || 'Logged in';
          btnLogin.style.display = 'none';
          btnSignOut.style.display = '';
        } else {
          authStatus.textContent = 'Belum login';
          btnLogin.style.display = '';
          btnSignOut.style.display = 'none';
        }
      })();

      btnSignOut?.addEventListener('click', async ()=>{
        await __supa.auth.signOut();
        window.location.replace('login.html');
      });

      // Auto data-label untuk semua tabel berdasarkan thead
      function hydrateTables(){
        document.querySelectorAll('table').forEach(tbl=>{
          const heads = Array.from(tbl.querySelectorAll('thead th')).map(th => th.textContent.trim());
          if(!heads.length) return;
          tbl.querySelectorAll('tbody tr').forEach(tr=>{
            Array.from(tr.children).forEach((td, idx)=>{
              if(!td.hasAttribute('data-label') && heads[idx]){
                td.setAttribute('data-label', heads[idx]);
              }
            });
          });
        });
      }
      hydrateTables();
    })();
  </script>
</body>
</html>
