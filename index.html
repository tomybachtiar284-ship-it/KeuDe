<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laporan Keuangan K-PT DKE</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Supabase v2 (cukup sekali saja) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ====== CETAK (GLOBAL) ====== -->
  <style>
    @page { margin: 12mm; }
    @media print {
      /* Sembunyikan elemen navigasi & tombol */
      .sidebar,
      .topbar,
      .no-print,
      .panel-header .btn,
      td .btn,
      .actions,
      button,
      a.btn { display: none !important; }

      /* Sembunyikan panel FORM di semua halaman (Chrome/Edge mendukung :has) */
      .panel:has(form) { display: none !important; }

      /* Fallback jika :has() tidak didukung: sembunyikan panel pertama (form) */
      #view-receipt   .panel:first-of-type,
      #view-quotation .panel:first-of-type,
      #view-invoice   .panel:first-of-type { display: none !important; }

      /* Sembunyikan kolom aksi pada tabel yang ditandai */
      table.has-actions th:last-child,
      table.has-actions td:last-child { display: none !important; }

      /* Rapikan layout agar konten naik ke atas */
      .main  { width:100% !important; margin:0 !important; padding:0 6mm !important; }
      .view  { padding:0 !important; margin:0 !important; }
      .panel { box-shadow:none !important; margin:0 0 8mm !important; }

      /* Area cetak khusus tetap tampil */
      .print-area { display:block !important; page-break-inside:avoid; margin-top:4mm; }
    }
  </style>

  <!-- Auth Guard: kalau belum login -> redirect ke login.html -->
  <script>
    const SUPABASE_URL = 'https://jllomycpshgbhppipyaj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbG9teWNwc2hnYmhwcGlweWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzg2OTcsImV4cCI6MjA3NTg1NDY5N30.DQYcB25G6blGpQnxyLlaqsX8OTXWMc7q51EtJN35vY4';
    const __supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (async () => {
      try {
        const { data: { user } } = await __supa.auth.getUser();
        if (!user) window.location.replace('login.html');
      } catch {
        window.location.replace('login.html');
      }
    })();
  </script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">KeuDe</div>
      <nav class="menu">
        <button class="nav-link active" data-view="dashboard">Dashboard</button>
        <div class="menu-sep">Laporan</div>
        <button class="nav-link" data-view="balance-sheet">Laporan Neraca</button>
        <button class="nav-link" data-view="cash-flow">Laporan Arus Kas</button>
        <button class="nav-link" data-view="income-statement">Laporan Laba Rugi</button>
        <button class="nav-link" data-view="report-income">Laporan Pemasukan</button>
        <button class="nav-link" data-view="report-expense">Laporan Pengeluaran</button>
        <button class="nav-link" data-view="report-tax">Laporan Pembayaran Pajak</button>
        <div class="menu-sep">Dokumen</div>
        <button class="nav-link" data-view="receipt">Cetak Kwitansi</button>
        <button class="nav-link" data-view="quotation">Penawaran Harga</button>
        <button class="nav-link" data-view="invoice">Invoice</button>
        <div class="menu-sep">Data</div>
        <button class="nav-link" data-view="settings">Export / Import</button>
      </nav>
      <footer class="sidebar-footer">
        <small>© <span id="year"></span> KeuDe</small>
        <div class="auth" style="margin-top:10px">
          <div id="authStatus">Belum login</div>
          <a href="login.html" class="btn" id="btnGoLogin" style="margin-top:6px">Login/Signup</a>
          <button id="btnSignOut" class="btn" style="margin-top:6px; display:none">Logout</button>
        </div>
      </footer>
    </aside>

    <main class="main">
      <header class="topbar">
        <h1 id="viewTitle">Dashboard</h1>
        <div class="topbar-actions">
          <button id="btnAddIncome" class="btn primary">+ Pemasukan</button>
          <button id="btnAddExpense" class="btn danger">+ Pengeluaran</button>
          <button id="btnAddTax" class="btn warning">+ Pajak</button>
        </div>
      </header>

      <!-- DASHBOARD -->
      <section class="view" id="view-dashboard">
        <div class="cards">
          <div class="card"><div class="card-title">Saldo Kas</div><div class="stat" id="statCash">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pemasukan (bulan ini)</div><div class="stat" id="statIncome">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pengeluaran (bulan ini)</div><div class="stat" id="statExpense">Rp 0</div></div>
          <div class="card"><div class="card-title">Total Pajak (bulan ini)</div><div class="stat" id="statTax">Rp 0</div></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3>Transaksi Terbaru</h3>
            <div>
              <input type="month" id="dashMonth" />
              <button class="btn" id="btnDashFilter">Terapkan</button>
            </div>
          </div>
          <div class="table-wrap">
            <!-- punya kolom Aksi → has-actions -->
            <table class="table has-actions">
              <thead>
                <tr>
                  <th>Tanggal</th><th>Jenis</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th><th>Aksi</th>
                </tr>
              </thead>
              <tbody id="tblRecent"></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3>Dokumen Cepat</h3>
            <div class="actions">
              <button class="btn" data-view-jump="receipt">Buat Kwitansi</button>
              <button class="btn" data-view-jump="quotation">Buat Penawaran</button>
              <button class="btn" data-view-jump="invoice">Buat Invoice</button>
            </div>
          </div>
          <p>Dokumen-dokumen ini akan terikat ke transaksi (jika relevan) dan bisa dicetak langsung.</p>
        </div>
      </section>

      <!-- NERACA -->
      <section class="view hidden" id="view-balance-sheet">
        <div class="panel">
          <div class="panel-header">
            <h3>Neraca</h3>
            <div>
              <input type="date" id="bsDate" />
              <button class="btn" id="btnBsRun">Hitung</button>
              <button class="btn" id="btnBsPrint">Cetak</button>
            </div>
          </div>
          <div id="bsResult"></div>
        </div>
      </section>

      <!-- ARUS KAS -->
      <section class="view hidden" id="view-cash-flow">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Arus Kas</h3>
            <div>
              <input type="month" id="cfMonth" />
              <button class="btn" id="btnCfRun">Hitung</button>
              <button class="btn" id="btnCfPrint">Cetak</button>
            </div>
          </div>
          <div id="cfResult"></div>
        </div>
      </section>

      <!-- LABA RUGI -->
      <section class="view hidden" id="view-income-statement">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Laba Rugi</h3>
            <div>
              <input type="month" id="isMonth" />
              <button class="btn" id="btnIsRun">Hitung</button>
              <button class="btn" id="btnIsPrint">Cetak</button>
            </div>
          </div>
          <div id="isResult"></div>
        </div>
      </section>

      <!-- LAPORAN PEMASUKAN -->
      <section class="view hidden" id="view-report-income">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pemasukan</h3>
            <div>
              <input type="month" id="riMonth" />
              <button class="btn" id="btnRiRun">Terapkan</button>
              <button class="btn" id="btnRiExport">Export CSV</button>
              <button class="btn" id="btnRiPrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="riBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="riTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- LAPORAN PENGELUARAN -->
      <section class="view hidden" id="view-report-expense">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pengeluaran</h3>
            <div>
              <input type="month" id="reMonth" />
              <button class="btn" id="btnReRun">Terapkan</button>
              <button class="btn" id="btnReExport">Export CSV</button>
              <button class="btn" id="btnRePrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="reBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="reTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- LAPORAN PAJAK -->
      <section class="view hidden" id="view-report-tax">
        <div class="panel">
          <div class="panel-header">
            <h3>Laporan Pembayaran Pajak</h3>
            <div>
              <input type="month" id="rtMonth" />
              <button class="btn" id="btnRtRun">Terapkan</button>
              <button class="btn" id="btnRtExport">Export CSV</button>
              <button class="btn" id="btnRtPrint">Cetak</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table">
              <thead><tr><th>Tanggal</th><th>Kategori</th><th>Deskripsi</th><th class="num">Nominal</th></tr></thead>
              <tbody id="rtBody"></tbody>
              <tfoot><tr><th colspan="3" class="right">Total</th><th class="num" id="rtTotal">Rp 0</th></tr></tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- KWITANSI -->
      <section class="view hidden" id="view-receipt">
        <!-- PANEL FORM (akan tersembunyi saat print) -->
        <div class="panel">
          <div class="panel-header">
            <h3>Form Kwitansi</h3>
            <div>
              <button class="btn" id="btnReceiptNew">Baru</button>
              <button class="btn" id="btnReceiptPrint">Cetak</button>
            </div>
          </div>
          <form class="grid-2" id="formReceipt">
            <label>Nomor Kwitansi <input type="text" name="number" required /></label>
            <label>Tanggal <input type="date" name="date" required /></label>
            <label>Diterima dari <input type="text" name="from" required /></label>
            <label>Untuk Pembayaran <input type="text" name="for" required /></label>
            <label>Jumlah (Rp) <input type="number" step="0.01" name="amount" required /></label>
            <label>Metode <input type="text" name="method" placeholder="Transfer/Tunai" /></label>
            <label>Keterangan <input type="text" name="notes" /></label>
            <div class="actions">
              <button class="btn primary" id="btnReceiptSave" type="submit">Simpan</button>
            </div>
          </form>
        </div>

        <!-- RIWAYAT (yang akan dicetak) -->
        <div class="panel">
          <div class="panel-header"><h3>PT DKE Kwitansi</h3></div>
          <div class="table-wrap">
            <!-- punya kolom Aksi → has-actions -->
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Dari</th><th>Jumlah</th><th>Aksi</th></tr></thead>
              <tbody id="receiptList"></tbody>
            </table>
          </div>
        </div>

        <!-- Template cetak -->
        <div id="printAreaReceipt" class="print-area"></div>
      </section>

      <!-- QUOTATION -->
      <section class="view hidden" id="view-quotation">
        <div class="panel">
          <div class="panel-header">
            <h3>Penawaran Harga</h3>
            <div>
              <button class="btn" id="btnQuoteNew">Baru</button>
              <button class="btn" id="btnQuotePrint">Cetak</button>
            </div>
          </div>

          <form id="formQuote" class="grid-2">
            <label>No. Penawaran <input type="text" name="number" required></label>
            <label>Tanggal <input type="date" name="date" required></label>
            <label>Nama Klien <input type="text" name="client" required></label>
            <label>Email/Telepon <input type="text" name="contact"></label>
            <div class="full">
              <div class="items">
                <div class="items-header">
                  <span>Item</span><span>Qty</span><span>Harga</span><span>Subtotal</span><span></span>
                </div>
                <div id="quoteItems"></div>
                <button class="btn" id="btnQuoteAddItem" type="button">+ Item</button>
              </div>
            </div>
            <label>Diskon (%) <input type="number" step="0.01" name="discountPct" value="0"></label>
            <label>Pajak (%) <input type="number" step="0.01" name="taxPct" value="0"></label>
            <label class="full">Catatan <textarea name="notes" rows="3"></textarea></label>
            <div class="actions">
              <button class="btn primary" id="btnQuoteSave" type="submit">Simpan</button>
            </div>
          </form>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>Daftar Penawaran</h3></div>
          <div class="table-wrap">
            <!-- punya kolom Aksi → has-actions -->
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Klien</th><th class="num">Total</th><th>Aksi</th></tr></thead>
              <tbody id="quoteList"></tbody>
            </table>
          </div>
        </div>

        <div id="printAreaQuote" class="print-area"></div>
      </section>

      <!-- INVOICE -->
      <section class="view hidden" id="view-invoice">
        <div class="panel">
          <div class="panel-header">
            <h3>Invoice</h3>
            <div>
              <button class="btn" id="btnInvNew">Baru</button>
              <button class="btn" id="btnInvPrint">Cetak</button>
            </div>
          </div>

        <form id="formInv" class="grid-2">
          <label>No. Invoice <input type="text" name="number" required></label>
          <label>Tanggal <input type="date" name="date" required></label>
          <label>Jatuh Tempo <input type="date" name="dueDate" required></label>
          <label>Nama Klien <input type="text" name="client" required></label>
          <div class="full">
            <div class="items">
              <div class="items-header">
                <span>Item</span><span>Qty</span><span>Harga</span><span>Subtotal</span><span></span>
              </div>
              <div id="invItems"></div>
              <button class="btn" id="btnInvAddItem" type="button">+ Item</button>
            </div>
          </div>
          <label>Diskon (%) <input type="number" step="0.01" name="discountPct" value="0"></label>
          <label>Pajak (%) <input type="number" step="0.01" name="taxPct" value="0"></label>
          <label>Status
            <select name="status">
              <option>Draft</option>
              <option>Sent</option>
              <option>Paid</option>
            </select>
          </label>
          <label class="full">Catatan <textarea name="notes" rows="3"></textarea></label>
          <div class="actions">
            <button class="btn primary" id="btnInvSave" type="submit">Simpan</button>
          </div>
        </form>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>Daftar Invoice</h3></div>
          <div class="table-wrap">
            <!-- punya kolom Aksi → has-actions -->
            <table class="table has-actions">
              <thead><tr><th>Tanggal</th><th>Nomor</th><th>Klien</th><th>Status</th><th class="num">Total</th><th>Aksi</th></tr></thead>
              <tbody id="invList"></tbody>
            </table>
          </div>
        </div>

        <div id="printAreaInv" class="print-area"></div>
      </section>

      <!-- SETTINGS -->
      <section class="view hidden" id="view-settings">
        <div class="panel">
          <div class="panel-header"><h3>Export / Import Data</h3></div>
          <div class="grid-2">
            <div>
              <p>Export seluruh data (transaksi, kwitansi, penawaran, invoice) ke file JSON.</p>
              <button class="btn" id="btnExport">Export JSON</button>
            </div>
            <div>
              <p>Import data dari file JSON (akan menimpa data yang ada).</p>
              <input type="file" id="fileImport" accept="application/json" />
              <button class="btn" id="btnImport">Import</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- DIALOG TRANSAKSI -->
  <dialog id="txDialog">
    <form method="dialog" id="formTx" class="tx-form">
      <h3 id="txTitle">Tambah Transaksi</h3>
      <label>Tanggal <input type="date" name="date" required /></label>
      <label>Jenis
        <select name="type">
          <option value="income">Pemasukan</option>
          <option value="expense">Pengeluaran</option>
          <option value="tax">Pajak</option>
        </select>
      </label>
      <label>Kategori <input type="text" name="category" placeholder="Penjualan, Operasional, PPh, dll" /></label>
      <label>Deskripsi <input type="text" name="description" /></label>
      <label>Nominal (Rp) <input type="number" step="0.01" name="amount" required /></label>
      <menu>
        <button value="cancel" class="btn">Batal</button>
        <button value="ok" class="btn primary" id="btnTxSave">Simpan</button>
      </menu>
    </form>
  </dialog>

  <template id="tmplItemRow">
    <div class="item-row">
      <input class="it-desc" placeholder="Deskripsi" />
      <input class="it-qty" type="number" step="0.01" value="1" />
      <input class="it-price" type="number" step="0.01" value="0" />
      <div class="it-subtotal">Rp 0</div>
      <button class="btn tiny danger it-del" type="button">×</button>
    </div>
  </template>

  <!-- App utama -->
  <script src="script.js"></script>
</body>
</html>
